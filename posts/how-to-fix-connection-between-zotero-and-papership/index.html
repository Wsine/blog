<!doctype html><html lang=en><head><meta http-equiv=Content-Type content="text/html" charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge, chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><title>Wsine's Blog</title>
<link rel=stylesheet href=https://fonts.xz.style/serve/inter.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.2/new.min.css></head><body><header><h1><a href=/ style=color:inherit;text-decoration:none>Wsine's Blog</a></h1><nav><a href=/>Home</a> /
<a href=/social>Social</a> /
<a href=/feed.xml>Subscribe</a></nav></header><p name=#top><b>Posted on: 2021 Nov 08</b></p><p>[TOC]</p><p><a href=https://www.zotero.org>Zotero</a> 作为一款开源文献管理工具，受到了很多科研工作者的喜爱，尤其是它能够安装插件以增强软件本身的功能。另一方面，<a href=https://www.papershipapp.com>Papership</a> 作为 iOS 及 iPadOS 上目前唯一与之适配的客户端，支持双向同步，综合体验十分出色。</p><p>然而，随着 Zotero 的不断更新以及 Papership 的年久失修，它们之间的友谊出现了小小的问题，困扰着很多现有用户。我遍寻网络资源，虽然找到了一些解决方案，但我觉得不够优雅，因此提出一套自己的解决方案，以供有类似需求的读者们参考。</p><h3 id=zotero-和-papership-之间的问题在哪>Zotero 和 Papership 之间的问题在哪</h3><p>在探讨解决方案之前，我们先来聊聊前文提到的问题具体在哪。</p><blockquote><p><a href=https://forums.zotero.org/discussion/64967/cant-access-webdav-files-from-papership-or-zotero-org>https://forums.zotero.org/discussion/64967/cant-access-webdav-files-from-papership-or-zotero-org</a></p></blockquote><p>Zotero 本身作为开源工具并不收费，但是免费的文件存储空间只提供 300M 的空间，对于大量阅读 PDF 文献的小伙伴来说，很快就会把这部分的配额给消耗殆尽。如果要进一步购买空间 2G 档位，则需要支付每年 20 美元的费用，对学生党来说有点高。但是好在 Zotero 允许外挂 WebDAV 来存放文件，十分良心，所以不少用户都选择以这种方式同步文献。</p><p>而 Papership 则是一个支持 Zotero 的第三方客户端，它可以直接登录 Zotero 账号以获取文献库中所有文献的 metadata 的信息，然后通过 WebDAV 链接直接访问文件，最终实现与 Zotero 的完美联动。</p><p>Papership 唯一额外要求的一点是需要将一个特殊的文本文件 lastsync.txt 放置在 WebDAV 的同步目录内，Papership 在同步文件时会优先检查这个文件，如果发现本地的文件变动时间没有比 lastsync.txt 存储的最后变动文件更新，则采取「懒同步」的方式——也就是不同步。</p><p>问题就出在 Papership 的同步机制上。随着 Zotero 的更新，不知道出于何种原因，Zotero 在同步 WebDAV 文件的时候会主动删除 lastsync.txt。这个机制让 Papership 失去了「懒同步」的参照系，导致在 Papership 中阅读和标注的内容无法更新到云端，Zotero 的文件变动也无法同步至 Papership。</p><p>更麻烦的是，Papership 已被确认被 Elsevier 公司收购了，而 Elsevier 旗下有自己的文献管理工具 Mendeley。收购完成后，Papership 的开发重点也转向了母公司的产品，甚至可能不会再修复和 Zotero 相关的 bug。与此同时，Zotero 也在开发自己的 iOS 客户端，beta 版发布至今仍未支持 WebDAV 同步。在各方原因和背景之下，夹在中间的用户们只好自行寻求解决方案。</p><h3 id=当前网上流行的解决方案>当前网上流行的解决方案</h3><p>目前，网络社群中解决该问题的主要方案是放弃 Papership，使用 Zotero 的插件来解决文件同步的问题。</p><p>Zotero 中有一个很多人都会安装的插件「zotfile」，它有一个功能可以把待阅读批注的文献发送到平板电脑上，然后等到在平板端阅读和标注后，再取回到整体的文献库中。它背后的工作原理是这样子的：</p><ul><li>将待阅读标注文献复制到另一个文件夹</li><li>该文件夹依靠第三方云存储进行同步（如 OneDrive、坚果云等）</li><li>在 Android 设备或 iPad 上用自己喜欢的批注工具阅读（如 PDF Expert 等）</li><li>将该文献从同步文件夹中移动并替换文献库的文件</li></ul><p><img src=https://image.wsine.top/b57bf92e3d21defae1565bf50e2bb715.png alt=image-20211216210137802></p><p>其中，发送和取回两个动作都需要手动操作，因此，从整体的联动性来说，我觉得是不够方便的。而且由于没有自动双向同步，将文献从 A 集合移动到 B 集合，它对应的存储位置不会改变，这对于我习惯使用 Inbox 来消化文章的用户来说，极大地不方便。</p><h3 id=如果没有就创造>如果没有就创造</h3><p>既然现有的解决方案不满意，那就创造自己的解决方案。</p><p>通过上文的讨论，我们知道整个问题的关键在于 lastsync.txt 文件身上，如何存储和恢复该文件就成了该解决方案的关键。同样地，我通过查询英文资料得知，哪怕只创建空白的 lastsync.txt ，也能激活 Papership，让它启动正确的同步机制。</p><p>手动创建 lastsync.txt 是一件很麻烦的事情，但是如今比较流行的 serverless 的技术却能够很好地帮助我们自动化完成这一目标。不少的 serverless 服务都是以 web 作为入口，且使用这些服务或需要绑定信用卡或需要备案，比较麻烦，因此我最终选择了 Github Actions 作为本次的自动化工具。</p><ul><li>注：serverless 是一种功能即服务（Function-as-a-Service），它也需要服务器运行，但分离了网页和数据库，仅保留运算部分对外提供服务。</li><li>注：如果你还不会使用 Github Actions，可以参考阮一峰大神的教程，简单易懂。https://www.ruanyifeng.com/blog/2019/09/getting-started-with-github-actions.html</li></ul><p>由于目标比较简单，因此两行简单的 bash 命令就可以完成核心的目标。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Bash data-lang=Bash><span style=display:flex><span>touch lastsync.txt
</span></span><span style=display:flex><span>curl -u <span style=color:#e6db74>${</span>WEBDAV_EMAIL<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>WEBDAV_DAVPASS<span style=color:#e6db74>}</span> -T lastsync.txt https://your/webdav/url/zotero/lastsync.txt
</span></span></code></pre></div><p>这两行的意思分别是：创建空白的 lastsync.txt 文件，上传到 WebDAV 的指定路径上。其中，<code>${WEBDAV_EMAIL}</code> 是你的 WebDAV 的登录账号或邮箱，<code>${WEBDAV_DAVPASS}</code> 是你 WebDAV 的应用密码。</p><p>然后只需要在 GitHub 的任意一个仓库中（可新建），在 <code>.github/workflows/webdav_lastsync.yml</code><a href=https://github.com/Wsine/actions/tree/main/.github/workflows> </a>路径下放入这两行代码即可，具体的文件模板我都给大家创建好了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>webdav_lastsync</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>schedule</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>cron</span>: <span style=color:#e6db74>&#39;0 4,16 * * *&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>workflow_dispatch</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>fix</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-18.04</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Fix</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          export SYNCFILE=&#34;lastsync.txt&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          export REMOTEFILE=&#34;https://app.koofr.net/dav/Koofr/zotero/${SYNCFILE}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          touch ${SYNCFILE}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          curl -u ${KOOFR_EMAIL}:${KOOFR_DAVPASS} -T ${SYNCFILE} ${REMOTEFILE}</span>          
</span></span><span style=display:flex><span>        <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>KOOFR_EMAIL</span>: <span style=color:#ae81ff>${{ secrets.KOOFR_EMAIL }}</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>KOOFR_DAVPASS</span>: <span style=color:#ae81ff>${{ secrets.KOOFR_DAVPASS }}</span>
</span></span></code></pre></div><p>该文件也是我放在 Github 中的实际文件，以一个具体的例子供大家参考，记得修改为自己的字段。</p><p>该 workflow 会在北京时间的每天 12 点和 0 点自动运行一遍，我觉得已经能满足我日常的同步需求了，我并不需要完全的实时同步。如果你希望增加同步的频率，在第 5 行中的 <code>4,16</code> 处增加你想同步的整点时间即可。值得注意的是，这里的时间是以格林威治时间为标准的，换算为北京时间（UTC+8）时，需要将你的目标时间倒推 8 小时。</p><p>创建完该 workflow 后，别忘了在 GitHub 的 settings -> secrets 中添加你的登录邮箱和应用密码字段。接下来，GitHub Actions 就会依照你设定好的时间，自动生成 lastsync.txt 并同步至你的 WebDAV 目录，Papership 只要识别到该文件，也会保持同步状态啦。</p><p>该解决方案已正确运行一周，解决了我的巨大的痛点，仅以此文献给有需要的小伙伴。</p><p style=text-align:right><a href=#top>↑ Back to Top</a></p><div style=margin-top:3rem></div><p>Contact me if you have any comments or questions about this aritcle.</p><p>Appriciate if you would like to support me if the article really helps you.</p><iframe src=https://github.com/sponsors/Wsine/button title="Sponsor Wsine" height=32 width=114 style=border:0;border-radius:6px;float:right></iframe><div style=margin-bottom:5rem></div><footer style=color:grey;text-align:center>Copyright &copy; 2019-Now &#183; CC <a style=color:grey href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en>BY-NC-SA 4.0</a> &#183; Powered by <a style=color:grey href=https://gohugo.io/>Hugo</a></footer></body></html>